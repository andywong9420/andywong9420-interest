// --- Canvas Loop ---
function gameLoop() {
    frameCount++;
    
    // 1. Clear Screen
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // 2. Day/Night Background
    let skyColor = '#87CEEB'; // Lvl 1
    if (level === 2 || level === 3) skyColor = '#e67e22'; // Afternoon
    if (level >= 4) skyColor = '#2c3e50'; // Night
    
    ctx.fillStyle = skyColor; 
    ctx.fillRect(0, 0, canvas.width, canvas.height / 2);
    
    ctx.fillStyle = level >= 4 ? '#145a32' : '#27ae60'; // Grass
    ctx.fillRect(0, canvas.height / 2, canvas.width, canvas.height / 2);

    // 3. Grid Lines (Perspective)
    const cx = canvas.width / 2;
    const cy = canvas.height / 2;

    ctx.strokeStyle = level >= 4 ? '#0b5345' : '#1e8449';
    ctx.lineWidth = 2;
    ctx.beginPath();

    // Radiating lines
    for (let i = -10; i <= 10; i++) {
        // Draw lines extending from center to bottom
        // Use wider spread multiplier for landscape
        let spread = canvas.width > canvas.height ? 4.0 : 2.5; 
        ctx.moveTo(cx, cy);
        ctx.lineTo(cx + (i * cx * spread), canvas.height);
    }
    
    // Horizon Lines (Moving Effect)
    // Speed logic
    let currentSpeed = currentState === 'RUNNING' ? 8.0 : gridSpeed;
    let moveOffset = (frameCount * currentSpeed) % 40;
    
    for (let i = 0; i < 15; i++) {
        // Exponential distance for 3D feel
        let dist = (i * 30 + moveOffset);
        // yPos starts at cy (horizon) and moves down
        let yPos = cy + Math.pow(dist, 1.3) * (canvas.height * 0.0002); 
        
        if (yPos > canvas.height) continue;
        ctx.moveTo(0, yPos);
        ctx.lineTo(canvas.width, yPos);
    }
    ctx.stroke();

    // 4. Draw Monster (Coordinate Fix)
    // Ensure it is drawn exactly at center X, and slightly below horizon Y
    let shakeX = currentState === 'RUNNING' ? (Math.random()-0.5)*15 : 0;
    
    // Calculate a safe size relative to screen height
    let baseSize = canvas.height * 0.2; // Monster is 20% of screen height
    
    drawMonster(cx + shakeX, cy + baseSize, monsterScale, baseSize);

    // 5. Draw Sword
    let swordY = canvas.height; // Start from bottom
    if (currentState === 'RUNNING') swordY += Math.sin(frameCount*0.8)*30;
    
    // Draw sword slightly to the right of center
    drawSword(cx + (canvas.width * 0.15), swordY, canvas.height * 0.3);

    // 6. Particles
    for (let i = particles.length - 1; i >= 0; i--) {
        particles[i].update();
        particles[i].draw(ctx);
        if (particles[i].life <= 0) particles.splice(i, 1);
    }

    requestAnimationFrame(gameLoop);
}

function drawMonster(x, y, scale, sizePx) {
    // Cap scale so it doesn't cover UI
    let finalScale = scale;
    if (finalScale > 3) finalScale = 3; 

    ctx.save();
    ctx.translate(x, y);
    
    // Apply scale and size
    // sizePx is the reference "1.0" size in pixels
    let s = finalScale * (sizePx / 100); 
    ctx.scale(s, s);
    
    // Draw Monster centered at (0,0)
    // Shift UP by 50 units so (x,y) is the feet/base
    ctx.translate(0, -50); 

    // Body (Slime)
    ctx.fillStyle = level >= 4 ? '#8e44ad' : '#9b59b6';
    ctx.beginPath();
    ctx.arc(0, 0, 50, Math.PI, 0); // Top dome
    ctx.bezierCurveTo(50, 50, -50, 50, -50, 0); // Bottom wobble
    ctx.fill();
    
    // Stroke (Outline)
    ctx.strokeStyle = 'black';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    // Face
    ctx.fillStyle = 'white';
    ctx.beginPath(); ctx.arc(-20, -10, 12, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(20, -10, 12, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = 'red';
    ctx.beginPath(); ctx.arc(-20, -10, 4, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(20, -10, 4, 0, Math.PI*2); ctx.fill();
    
    ctx.restore();
}

function drawSword(x, y, length) {
    ctx.save();
    ctx.translate(x, y);
    
    // Scale sword based on screen height
    let s = length / 200;
    ctx.scale(s, s);
    
    ctx.rotate(-0.4);
    
    // Blade
    ctx.fillStyle = '#bdc3c7';
    ctx.fillRect(-10, -200, 20, 200);
    ctx.strokeStyle = '#7f8c8d';
    ctx.lineWidth = 2;
    ctx.strokeRect(-10, -200, 20, 200);
    
    // Guard
    ctx.fillStyle = '#f1c40f';
    ctx.fillRect(-30, 0, 60, 15);
    ctx.strokeRect(-30, 0, 60, 15);
    
    // Grip
    ctx.fillStyle = '#8e44ad';
    ctx.fillRect(-8, 15, 16, 50);
    
    ctx.restore();
}
