// === éŠæˆ²ç‹€æ…‹ç®¡ç† ===
const state = {
    mode: 'menu', // 'menu', 'portrait', 'landscape'
    level: 1,
    health: 5,
    score: 0,
    combo: 0,
    questionsInLevel: 0,
    maxQuestions: 30,
    question: null,
    lastCalcAns: 0,
    isFever: false
};

// === Canvas è¨­å®š ===
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let animationId;

// === é˜²æ­¢ iOS Safari é›™æ“Šç¸®æ”¾ ===
let lastTouchEnd = 0;
document.addEventListener('touchend', function (event) {
  const now = (new Date()).getTime();
  if (now - lastTouchEnd <= 300) {
    event.preventDefault();
  }
  lastTouchEnd = now;
}, { passive: false });

// === æ•¸å­¸é¡Œç›®ç”Ÿæˆå™¨ (æ ¸å¿ƒé‚è¼¯) ===
const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const randItem = (arr) => arr[Math.floor(Math.random() * arr.length)];
const round2 = (num) => Math.round(num * 100) / 100;

const HK_CONTEXTS = [
    "ä½ å„²èµ·å’—æ–°å¹´å˜…åˆ©æ˜¯éŒ¢ã€‚",
    "ä½ æƒ³å…©å¹´å¾Œè²·éƒ¨ PS5 Proã€‚",
    "ä½ åœ¨éº¥ç•¶å‹å…¼è·å„²äº†ä¸€ç­†éŒ¢ã€‚",
    "ä½ æ‰“ç®—å»æ—¥æœ¬æ—…è¡Œå„²æ—…è²»ã€‚",
    "çˆ¸çˆ¸çµ¦ä½ ä¸€ç­†éŒ¢ä½œå¤§å­¸åŸºé‡‘ã€‚"
];

function generateQuestion(level) {
    let P, r, t, n, A, I, ans, qText;
    
    // æ³¨æ„ï¼šé€™è£¡æ”¹ç”¨ let å®£å‘Šä¸¦çµ¦åˆå§‹ç©ºå€¼ï¼Œé¿å… const éŒ¯èª¤
    let formulaStr = ""; 
    
    const context = randItem(HK_CONTEXTS);
    
    // é›£åº¦åƒæ•¸
    P = randInt(10, 100) * 100; // 1000 - 10000
    r = randInt(2, 15); // 2% - 15%
    t = randInt(1, 5); // å¹´ä»½

    // Level 1: å–®åˆ©æ¯ (æ‰¾ I æˆ– A)
    if (level === 1) {
        I = (P * r * t) / 100;
        A = P + I;
        if (Math.random() > 0.5) {
            qText = `${context}<br>æœ¬é‡‘ $${P}ï¼Œå¹´åˆ©ç‡ ${r}%ï¼Œå–®åˆ©æ¯å­˜æ¬¾ ${t} å¹´ã€‚<br>æ±‚åˆ©æ¯ (Interest)ã€‚`;
            formulaStr = `I = P Ã— R% Ã— T <br>= ${P} Ã— ${r}% Ã— ${t}`;
            ans = I;
        } else {
            qText = `${context}<br>æœ¬é‡‘ $${P}ï¼Œå¹´åˆ©ç‡ ${r}%ï¼Œå–®åˆ©æ¯å­˜æ¬¾ ${t} å¹´ã€‚<br>æ±‚æœ¬åˆ©å’Œ (Amount)ã€‚`;
            formulaStr = `A = P + I = P + (P Ã— R% Ã— T) <br>= ${P} + (${P} Ã— ${r}% Ã— ${t})`;
            ans = A;
        }
    }
    // Level 2: è¤‡åˆ©æ¯ (æ¯å¹´)
    else if (level === 2) {
        A = P * Math.pow((1 + r/100), t);
        I = A - P;
        if (Math.random() > 0.5) {
            qText = `${context}<br>æœ¬é‡‘ $${P}ï¼Œå¹´åˆ©ç‡ ${r}%ï¼Œè¤‡åˆ©æ¯(æ¯å¹´ä¸€çµ)å­˜æ¬¾ ${t} å¹´ã€‚<br>æ±‚æœ¬åˆ©å’Œã€‚`;
            formulaStr = `A = P(1 + r%)^n <br>= ${P}(1 + ${r}%)^${t}`;
            ans = A;
        } else {
            qText = `${context}<br>æœ¬é‡‘ $${P}ï¼Œå¹´åˆ©ç‡ ${r}%ï¼Œè¤‡åˆ©æ¯(æ¯å¹´ä¸€çµ)å­˜æ¬¾ ${t} å¹´ã€‚<br>æ±‚åˆ©æ¯ã€‚`;
            formulaStr = `I = A - P <br>= (${P}(1 + ${r}%)^${t}) - ${P}`;
            ans = I;
        }
    }
    // Level 3: è¤‡åˆ©æ¯ (ä¸åŒæœŸæ•¸)
    else if (level === 3) {
        const periods = [
            { n: 2, name: "æ¯åŠå¹´(Half-yearly)" },
            { n: 4, name: "æ¯å­£(Quarterly)" },
            { n: 12, name: "æ¯æœˆ(Monthly)" },
            { n: 365, name: "æ¯æ—¥(Daily)" }
        ];
        const pObj = randItem(periods);
        n = pObj.n;
        A = P * Math.pow((1 + r/100/n), n*t);
        qText = `${context}<br>æœ¬é‡‘ $${P}ï¼Œå¹´åˆ©ç‡ ${r}%ï¼Œè¤‡åˆ©æ¯ <b>${pObj.name}</b> ä¸€çµï¼Œå­˜æ¬¾ ${t} å¹´ã€‚<br>æ±‚æœ¬åˆ©å’Œã€‚`;
        formulaStr = `A = P(1 + r%/n)^(nÃ—t) <br>= ${P}(1 + ${r}%/${n})^(${n}Ã—${t})`;
        ans = A;
    }
    // Level 4: é€†å‘ (å–®åˆ©æ¯/è¤‡åˆ©æ¯ æ‰¾ P, r, t)
    else if (level === 4) {
        const type = Math.random() > 0.6 ? 'simple' : 'compound_P'; 
        
        if (type === 'simple') {
            I = (P * r * t) / 100;
            const missing = randItem(['P', 'r', 't']);
            if (missing === 'P') {
                qText = `${context}<br>å–®åˆ©æ¯å­˜æ¬¾ï¼Œå¹´åˆ©ç‡ ${r}%ï¼Œå­˜æœŸ ${t} å¹´ï¼Œç²å¾—åˆ©æ¯ $${I}ã€‚<br>æ±‚æœ¬é‡‘ (Principal)ã€‚`;
                formulaStr = `P = (I Ã— 100) / (R Ã— T)`;
                ans = P;
            } else if (missing === 'r') {
                qText = `${context}<br>å–®åˆ©æ¯å­˜æ¬¾ï¼Œæœ¬é‡‘ $${P}ï¼Œå­˜æœŸ ${t} å¹´ï¼Œç²å¾—åˆ©æ¯ $${I}ã€‚<br>æ±‚å¹´åˆ©ç‡ (R%)ã€‚(åªè¼¸å…¥æ•¸å­—)`;
                formulaStr = `R = (I Ã— 100) / (P Ã— T)`;
                ans = r;
            } else {
                qText = `${context}<br>å–®åˆ©æ¯å­˜æ¬¾ï¼Œæœ¬é‡‘ $${P}ï¼Œå¹´åˆ©ç‡ ${r}%ï¼Œç²å¾—åˆ©æ¯ $${I}ã€‚<br>æ±‚å¹´æœŸ (T)ã€‚`;
                formulaStr = `T = (I Ã— 100) / (P Ã— R)`;
                ans = t;
            }
        } else {
            // Find P in Compound
            A = P * Math.pow((1 + r/100), t);
            A = round2(A);
            qText = `${context}<br>è¤‡åˆ©æ¯(æ¯å¹´ä¸€çµ)ï¼Œå¹´åˆ©ç‡ ${r}%ï¼Œå­˜æœŸ ${t} å¹´ï¼Œæœ¬åˆ©å’Œç‚º $${A}ã€‚<br>æ±‚æœ¬é‡‘ (Principal) (å–æ•´æ•¸)ã€‚`;
            formulaStr = `P = A / (1 + r%)^n`;
            ans = Math.round(A / Math.pow((1 + r/100), t));
        }
    }
    // Level 5: é€†å‘ (è¤‡åˆ©æ¯ + æœŸæ•¸)
    else {
        const periods = [{n:4, name:'æ¯å­£'}, {n:12, name:'æ¯æœˆ'}];
        const pObj = randItem(periods);
        n = pObj.n;
        A = P * Math.pow((1 + r/100/n), n*t);
        A = round2(A);
        qText = `${context}<br>è¤‡åˆ©æ¯ <b>${pObj.name}</b> ä¸€çµï¼Œå¹´åˆ©ç‡ ${r}%ï¼Œå­˜æœŸ ${t} å¹´ï¼Œæœ¬åˆ©å’Œ $${A}ã€‚<br>æ±‚æœ¬é‡‘ (Principal) (å–æ•´æ•¸)ã€‚`;
        formulaStr = `P = A / (1 + r%/n)^(nÃ—t)`;
        ans = Math.round(A / Math.pow((1 + r/100/n), n*t));
    }

    return {
        text: qText,
        answer: round2(ans),
        formula: formulaStr
    };
}

// === ç²’å­ç³»çµ± (Game Juice) ===
let particles = [];
class Particle {
    constructor(x, y, color) {
        this.x = x; this.y = y;
        this.vx = (Math.random() - 0.5) * 15;
        this.vy = (Math.random() - 0.5) * 15;
        this.life = 1.0;
        this.color = color;
    }
    update() {
        this.x += this.vx;
        this.y += this.vy;
        this.life -= 0.03;
        this.vy += 0.5; // é‡åŠ›
    }
    draw(ctx) {
        ctx.globalAlpha = this.life;
        ctx.fillStyle = this.color;
        ctx.fillRect(this.x, this.y, 8, 8);
        ctx.globalAlpha = 1.0;
    }
}

// === ç¹ªåœ–é‚è¼¯ ===
// å¤©ç©ºé¡è‰² [æ—©æ™¨, ä¸‹åˆ, æ™šä¸Š, æ·±å¤œ, è™›ç©º]
const SKY_COLORS = ['#87CEEB', '#FFA500', '#191970', '#4B0082', '#220000'];

let gridOffset = 0;
let monsterScale = 1.0; 

function drawGame() {
    // 1. èƒŒæ™¯ (Day/Night Cycle)
    const skyColor = SKY_COLORS[Math.min(state.level - 1, 4)];
    ctx.fillStyle = skyColor;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 2. å½ 3D åœ°æ¿æ ¼ç·š
    const horizon = canvas.height * 0.5;
    ctx.fillStyle = '#222'; 
    ctx.fillRect(0, horizon, canvas.width, canvas.height / 2);

    ctx.strokeStyle = state.isFever ? '#FFD700' : '#00FF00'; 
    ctx.lineWidth = 2;
    ctx.beginPath();

    const centerX = canvas.width / 2;
    for (let i = -10; i <= 10; i++) {
        ctx.moveTo(centerX, horizon);
        ctx.lineTo(centerX + i * (canvas.width / 2), canvas.height);
    }

    gridOffset = (gridOffset + (state.isFever ? 4 : 1)) % 50;
    for (let y = horizon; y < canvas.height; y += 50) {
        let drawY = y + gridOffset;
        if (drawY > canvas.height) drawY -= (canvas.height - horizon);
        ctx.moveTo(0, drawY);
        ctx.lineTo(canvas.width, drawY);
    }
    ctx.stroke();

    // 3. æ€ªç‰© (Emoji ç¹ªè£½ï¼Œæ›´ç”Ÿå‹•)
    monsterScale = 1 + Math.sin(Date.now() / 500) * 0.1;
    const mx = canvas.width / 2;
    const my = canvas.height / 2 + 30;
    const size = 150 * monsterScale;

    ctx.font = `${size}px Arial`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    const monsters = ['ğŸ‘¾', 'ğŸ‘¹', 'ğŸ¤–', 'ğŸ²', 'ğŸ’€'];
    ctx.fillText(monsters[state.level - 1] || 'ğŸ‘½', mx, my);

    // 4. ç²’å­æ•ˆæœ
    particles.forEach((p, index) => {
        p.update();
        p.draw(ctx);
        if (p.life <= 0) particles.splice(index, 1);
    });
}

function gameLoop() {
    if (state.mode === 'menu') return;
    ctx.clearRect(0, 0,
